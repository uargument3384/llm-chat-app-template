<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>LLM Chat App with Auth & History</title>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown-light.min.css" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css" />
		<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.3/purify.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
		<style>
			:root {
				--primary-color: #f6821f;
				--primary-hover: #e67e22;
				--light-bg: #f9fafb;
				--border-color: #e5e7eb;
				--text-color: #1f2937;
				--text-light: #6b7280;
				--user-msg-bg: #fff2e6;
				--assistant-msg-bg: #f3f4f6;
				--sidebar-width: 260px;
			}

			* {
				box-sizing: border-box;
				margin: 0;
				padding: 0;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
				line-height: 1.6;
				color: var(--text-color);
				background-color: white;
				height: 100vh;
				display: flex;
				flex-direction: column;
			}

			.app-layout {
				display: flex;
				flex: 1;
				overflow: hidden;
			}

			.sidebar {
				width: var(--sidebar-width);
				background-color: var(--light-bg);
				border-right: 1px solid var(--border-color);
				display: flex;
				flex-direction: column;
				transition: transform 0.3s ease;
			}

			.sidebar-header {
				padding: 1rem;
				border-bottom: 1px solid var(--border-color);
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.new-chat-btn {
				width: 100%;
				padding: 0.5rem;
				background-color: white;
				border: 1px solid var(--border-color);
				border-radius: 4px;
				cursor: pointer;
				color: var(--text-color);
				margin-top: 0.5rem;
			}

			.new-chat-btn:hover {
				background-color: var(--assistant-msg-bg);
			}

			.history-list {
				flex: 1;
				overflow-y: auto;
				padding: 0.5rem;
			}

			.history-item {
				padding: 0.75rem;
				border-radius: 4px;
				cursor: pointer;
				margin-bottom: 0.25rem;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
				font-size: 0.9rem;
			}

			.history-item:hover {
				background-color: #e5e7eb;
			}

			.history-item.active {
				background-color: #fed7aa;
				color: #9a3412;
			}

			.user-profile {
				padding: 1rem;
				border-top: 1px solid var(--border-color);
				display: flex;
				justify-content: space-between;
				align-items: center;
				font-size: 0.9rem;
			}

			.logout-btn {
				background: none;
				border: none;
				color: var(--text-light);
				cursor: pointer;
				text-decoration: underline;
			}

			.main-content {
				flex: 1;
				display: flex;
				flex-direction: column;
				height: 100%;
				position: relative;
			}

			header {
				padding: 1rem;
				border-bottom: 1px solid var(--border-color);
				display: flex;
				align-items: center;
				justify-content: space-between;
			}

			h1 {
				font-size: 1.25rem;
				color: var(--primary-color);
			}

			.chat-messages {
				flex: 1;
				overflow-y: auto;
				padding: 1rem;
				display: flex;
				flex-direction: column;
				gap: 1rem;
			}

			.message {
				padding: 1rem;
				border-radius: 8px;
				max-width: 85%;
				word-wrap: break-word;
			}

			.user-message {
				background-color: var(--user-msg-bg);
				align-self: flex-end;
				margin-left: auto;
			}

			.assistant-message {
				background-color: var(--assistant-msg-bg);
				align-self: flex-start;
			}

			.markdown-body {
				background-color: transparent !important;
				font-size: 1rem;
			}
			
			.markdown-body pre {
				background-color: #f6f8fa !important;
			}

			.message-input-container {
				padding: 1rem;
				border-top: 1px solid var(--border-color);
				background-color: white;
			}

			.message-input-wrapper {
				display: flex;
				gap: 0.5rem;
				max-width: 800px;
				margin: 0 auto;
			}

			#user-input {
				flex: 1;
				padding: 0.75rem;
				border: 1px solid var(--border-color);
				border-radius: 4px;
				font-family: inherit;
				resize: none;
				min-height: 44px;
				max-height: 200px;
			}

			#send-button {
				padding: 0 1.5rem;
				background-color: var(--primary-color);
				color: white;
				border: none;
				border-radius: 4px;
				cursor: pointer;
				font-weight: 600;
			}

			#send-button:hover {
				background-color: var(--primary-hover);
			}

			#send-button:disabled {
				background-color: var(--text-light);
				cursor: not-allowed;
			}

			.auth-overlay {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background-color: rgba(0, 0, 0, 0.5);
				display: flex;
				justify-content: center;
				align-items: center;
				z-index: 1000;
			}

			.auth-card {
				background-color: white;
				padding: 2rem;
				border-radius: 8px;
				width: 100%;
				max-width: 400px;
				box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
			}

			.auth-card h2 {
				margin-bottom: 1.5rem;
				text-align: center;
				color: var(--text-color);
			}

			.form-group {
				margin-bottom: 1rem;
			}

			.form-group label {
				display: block;
				margin-bottom: 0.5rem;
				font-weight: 500;
			}

			.form-group input {
				width: 100%;
				padding: 0.5rem;
				border: 1px solid var(--border-color);
				border-radius: 4px;
			}

			.auth-btn {
				width: 100%;
				padding: 0.75rem;
				background-color: var(--primary-color);
				color: white;
				border: none;
				border-radius: 4px;
				cursor: pointer;
				font-size: 1rem;
			}

			.auth-switch {
				margin-top: 1rem;
				text-align: center;
				font-size: 0.9rem;
			}
			
			.auth-switch a {
				color: var(--primary-color);
				cursor: pointer;
				text-decoration: underline;
			}

			.hidden {
				display: none !important;
			}

			@media (max-width: 768px) {
				.sidebar {
					position: absolute;
					height: 100%;
					z-index: 100;
					transform: translateX(-100%);
				}
				
				.sidebar.open {
					transform: translateX(0);
				}
			}
		</style>
	</head>
	<body>
		<div id="auth-overlay" class="auth-overlay">
			<div class="auth-card">
				<h2 id="auth-title">Login</h2>
				<form id="auth-form">
					<div class="form-group">
						<label for="email">Email</label>
						<input type="email" id="email" required placeholder="Enter your email">
					</div>
					<div class="form-group">
						<label for="password">Password</label>
						<input type="password" id="password" required placeholder="Enter your password">
					</div>
					<button type="submit" class="auth-btn" id="auth-submit-btn">Login</button>
				</form>
				<div class="auth-switch">
					<span id="auth-switch-text">Don't have an account?</span>
					<a id="auth-switch-link">Sign up</a>
				</div>
			</div>
		</div>

		<div class="app-layout">
			<aside class="sidebar" id="sidebar">
				<div class="sidebar-header">
					<span>Chat History</span>
				</div>
				<div style="padding: 0 1rem;">
					<button class="new-chat-btn" id="new-chat-btn">+ New Chat</button>
				</div>
				<div class="history-list" id="history-list"></div>
				<div class="user-profile">
					<span id="user-email-display">user@example.com</span>
					<button class="logout-btn" id="logout-btn">Logout</button>
				</div>
			</aside>

			<main class="main-content">
				<header>
					<button id="toggle-sidebar" style="background:none;border:none;cursor:pointer;font-size:1.5rem;margin-right:1rem;">â˜°</button>
					<h1>Cloudflare AI Chat</h1>
				</header>

				<div id="chat-messages" class="chat-messages">
					<div class="message assistant-message markdown-body">
						<p>Hello! I'm an LLM chat app. I support **Markdown**, code blocks, and chat history. How can I help you?</p>
					</div>
				</div>

				<div class="message-input-container">
					<div class="message-input-wrapper">
						<textarea id="user-input" placeholder="Type a message (Markdown supported)..." rows="1"></textarea>
						<button id="send-button">Send</button>
					</div>
				</div>
			</main>
		</div>

		<script>
			const state = {
				user: null,
				token: localStorage.getItem('auth_token'),
				currentChatId: null,
				isLoginMode: true
			};

			const elements = {
				authOverlay: document.getElementById('auth-overlay'),
				authForm: document.getElementById('auth-form'),
				authTitle: document.getElementById('auth-title'),
				authSwitchLink: document.getElementById('auth-switch-link'),
				authSwitchText: document.getElementById('auth-switch-text'),
				emailInput: document.getElementById('email'),
				passwordInput: document.getElementById('password'),
				
				sidebar: document.getElementById('sidebar'),
				toggleSidebarBtn: document.getElementById('toggle-sidebar'),
				historyList: document.getElementById('history-list'),
				newChatBtn: document.getElementById('new-chat-btn'),
				userEmailDisplay: document.getElementById('user-email-display'),
				logoutBtn: document.getElementById('logout-btn'),
				
				chatMessages: document.getElementById('chat-messages'),
				userInput: document.getElementById('user-input'),
				sendButton: document.getElementById('send-button')
			};

			marked.setOptions({
				highlight: function(code, lang) {
					const language = highlight.getLanguage(lang) ? lang : 'plaintext';
					return highlight.highlight(code, { language }).value;
				},
				langPrefix: 'hljs language-'
			});

			function init() {
				if (state.token) {
					elements.authOverlay.classList.add('hidden');
					loadHistory();
					elements.userEmailDisplay.textContent = localStorage.getItem('user_email') || 'User';
				} else {
					elements.authOverlay.classList.remove('hidden');
				}
				setupEventListeners();
			}

			function setupEventListeners() {
				elements.toggleSidebarBtn.addEventListener('click', () => {
					elements.sidebar.classList.toggle('open');
					const currentDisplay = getComputedStyle(elements.sidebar).display;
					if(window.innerWidth > 768) {
						elements.sidebar.style.display = currentDisplay === 'none' ? 'flex' : 'none';
					}
				});

				elements.authSwitchLink.addEventListener('click', toggleAuthMode);
				elements.authForm.addEventListener('submit', handleAuth);
				elements.logoutBtn.addEventListener('click', logout);
				elements.newChatBtn.addEventListener('click', startNewChat);
				elements.sendButton.addEventListener('click', sendMessage);
				elements.userInput.addEventListener('keydown', (e) => {
					if (e.key === 'Enter' && !e.shiftKey) {
						e.preventDefault();
						sendMessage();
					}
				});
				elements.userInput.addEventListener('input', function() {
					this.style.height = 'auto';
					this.style.height = (this.scrollHeight) + 'px';
				});
			}

			function toggleAuthMode() {
				state.isLoginMode = !state.isLoginMode;
				elements.authTitle.textContent = state.isLoginMode ? 'Login' : 'Sign Up';
				elements.authSwitchText.textContent = state.isLoginMode ? "Don't have an account?" : "Already have an account?";
				elements.authSwitchLink.textContent = state.isLoginMode ? 'Sign up' : 'Login';
				document.getElementById('auth-submit-btn').textContent = state.isLoginMode ? 'Login' : 'Sign Up';
			}

			async function handleAuth(e) {
				e.preventDefault();
				const email = elements.emailInput.value;
				const password = elements.passwordInput.value;

				try {
					const endpoint = state.isLoginMode ? '/api/login' : '/api/register';
					
					const mockResponse = { token: 'mock-jwt-token-123', email: email };
					
					localStorage.setItem('auth_token', mockResponse.token);
					localStorage.setItem('user_email', mockResponse.email);
					state.token = mockResponse.token;
					
					elements.authOverlay.classList.add('hidden');
					elements.userEmailDisplay.textContent = email;
					loadHistory();
				} catch (error) {
					console.error('Auth error', error);
					alert('Authentication failed');
				}
			}

			function logout() {
				localStorage.removeItem('auth_token');
				localStorage.removeItem('user_email');
				state.token = null;
				location.reload();
			}

			function startNewChat() {
				state.currentChatId = Date.now().toString();
				elements.chatMessages.innerHTML = '';
				appendMessage('assistant', "Hello! I'm an LLM chat app. How can I help you today?");
				loadHistory(); 
			}

			function loadHistory() {
				const mockHistory = [
					{ id: '1', title: 'React Hooks Explanation' },
					{ id: '2', title: 'Cloudflare Workers Setup' },
					{ id: '3', title: 'Python Asyncio' }
				];
				
				elements.historyList.innerHTML = '';
				mockHistory.forEach(chat => {
					const div = document.createElement('div');
					div.className = `history-item ${chat.id === state.currentChatId ? 'active' : ''}`;
					div.textContent = chat.title;
					div.onclick = () => loadChatSession(chat.id);
					elements.historyList.appendChild(div);
				});
			}

			function loadChatSession(id) {
				state.currentChatId = id;
				elements.chatMessages.innerHTML = '';
				
				const mockMessages = [
					{ role: 'user', content: 'Tell me about id ' + id },
					{ role: 'assistant', content: `Here is the information about session ${id}. \n\n\`\`\`javascript\nconst x = ${id};\n\`\`\`` }
				];

				mockMessages.forEach(msg => appendMessage(msg.role, msg.content));
				loadHistory();
			}

			async function sendMessage() {
				const text = elements.userInput.value.trim();
				if (!text) return;

				appendMessage('user', text);
				elements.userInput.value = '';
				elements.userInput.style.height = 'auto';

				elements.sendButton.disabled = true;
				
				try {
					const responseText = "This is a **mock response** with Markdown support.\n\n```python\nprint('Hello World')\n```";
					setTimeout(() => {
						appendMessage('assistant', responseText);
						elements.sendButton.disabled = false;
					}, 1000);

				} catch (error) {
					console.error('Chat error', error);
					elements.sendButton.disabled = false;
				}
			}

			function appendMessage(role, text) {
				const div = document.createElement('div');
				div.className = `message ${role === 'user' ? 'user-message' : 'assistant-message'} markdown-body`;
				
				if (role === 'assistant') {
					const rawHtml = marked.parse(text);
					div.innerHTML = DOMPurify.sanitize(rawHtml);
				} else {
					div.textContent = text;
				}

				elements.chatMessages.appendChild(div);
				elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
			}

			init();
		</script>
	</body>
</html>

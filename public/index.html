<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Local LLM Chat</title>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown-light.min.css" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css" />
		<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.3/purify.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
		<style>
			:root {
				--primary-color: #f6821f;
				--primary-hover: #e67e22;
				--light-bg: #f9fafb;
				--border-color: #e5e7eb;
				--text-color: #1f2937;
				--text-light: #6b7280;
				--user-msg-bg: #fff2e6;
				--assistant-msg-bg: #f3f4f6;
				--sidebar-width: 260px;
			}

			* { box-sizing: border-box; margin: 0; padding: 0; }

			body {
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
				line-height: 1.6;
				color: var(--text-color);
				height: 100vh;
				display: flex;
				flex-direction: column;
			}

			.app-layout { display: flex; flex: 1; overflow: hidden; }

			.sidebar {
				width: var(--sidebar-width);
				background-color: var(--light-bg);
				border-right: 1px solid var(--border-color);
				display: flex;
				flex-direction: column;
			}

			.sidebar-header {
				padding: 1rem;
				border-bottom: 1px solid var(--border-color);
				font-weight: bold;
			}

			.new-chat-btn {
				width: calc(100% - 2rem);
				margin: 1rem;
				padding: 0.5rem;
				background-color: white;
				border: 1px solid var(--border-color);
				border-radius: 4px;
				cursor: pointer;
			}
			.new-chat-btn:hover { background-color: #f3f4f6; }

			.history-list {
				flex: 1;
				overflow-y: auto;
				padding: 0 0.5rem;
			}

			.history-item {
				padding: 0.75rem;
				border-radius: 4px;
				cursor: pointer;
				margin-bottom: 0.25rem;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
				font-size: 0.9rem;
				position: relative;
			}
			.history-item:hover { background-color: #e5e7eb; }
			.history-item.active { background-color: #fed7aa; color: #9a3412; }

			.delete-chat {
				position: absolute;
				right: 5px;
				top: 50%;
				transform: translateY(-50%);
				background: none;
				border: none;
				color: #ef4444;
				cursor: pointer;
				display: none;
				font-weight: bold;
				padding: 0 5px;
			}
			.history-item:hover .delete-chat { display: block; }

			.main-content {
				flex: 1;
				display: flex;
				flex-direction: column;
				height: 100%;
			}

			header {
				padding: 1rem;
				border-bottom: 1px solid var(--border-color);
				display: flex;
				align-items: center;
			}

			.chat-messages {
				flex: 1;
				overflow-y: auto;
				padding: 1rem;
				display: flex;
				flex-direction: column;
				gap: 1rem;
			}

			.message {
				padding: 1rem;
				border-radius: 8px;
				max-width: 85%;
			}
			.user-message { background-color: var(--user-msg-bg); align-self: flex-end; }
			.assistant-message { background-color: var(--assistant-msg-bg); align-self: flex-start; }

			.markdown-body { background-color: transparent !important; font-size: 1rem; }
			.markdown-body pre { background-color: #f6f8fa !important; }

			.message-input-container {
				padding: 1rem;
				border-top: 1px solid var(--border-color);
			}
			.message-input-wrapper {
				display: flex;
				gap: 0.5rem;
				max-width: 800px;
				margin: 0 auto;
			}
			#user-input {
				flex: 1;
				padding: 0.75rem;
				border: 1px solid var(--border-color);
				border-radius: 4px;
				resize: none;
				min-height: 44px;
				max-height: 200px;
			}
			#send-button {
				padding: 0 1.5rem;
				background-color: var(--primary-color);
				color: white;
				border: none;
				border-radius: 4px;
				cursor: pointer;
			}
			#send-button:disabled { background-color: var(--text-light); }

			@media (max-width: 768px) {
				.sidebar { display: none; }
			}
		</style>
	</head>
	<body>
		<div class="app-layout">
			<aside class="sidebar">
				<div class="sidebar-header">Local History</div>
				<button class="new-chat-btn" id="new-chat-btn">+ New Chat</button>
				<div class="history-list" id="history-list"></div>
				<div style="padding: 1rem; font-size: 0.8rem; color: var(--text-light); text-align: center;">
					Data saved in browser
					<br>
					<button id="clear-all" style="border:none; background:none; text-decoration:underline; color:inherit; cursor:pointer;">Clear All</button>
				</div>
			</aside>

			<main class="main-content">
				<header>
					<h1>Cloudflare AI Chat</h1>
				</header>

				<div id="chat-messages" class="chat-messages"></div>

				<div class="message-input-container">
					<div class="message-input-wrapper">
						<textarea id="user-input" placeholder="Type a message..." rows="1"></textarea>
						<button id="send-button">Send</button>
					</div>
				</div>
			</main>
		</div>

		<script>
			const state = {
				chats: [],
				currentChatId: null,
				isGenerating: false
			};

			const elements = {
				historyList: document.getElementById('history-list'),
				chatMessages: document.getElementById('chat-messages'),
				userInput: document.getElementById('user-input'),
				sendButton: document.getElementById('send-button'),
				newChatBtn: document.getElementById('new-chat-btn'),
				clearAllBtn: document.getElementById('clear-all')
			};

			marked.setOptions({
				highlight: (code, lang) => {
					const language = highlight.getLanguage(lang) ? lang : 'plaintext';
					return highlight.highlight(code, { language }).value;
				}
			});

			function init() {
				const saved = localStorage.getItem('llm_chat_history');
				if (saved) {
					try {
						state.chats = JSON.parse(saved);
					} catch (e) {
						state.chats = [];
					}
				}

				if (state.chats.length > 0) {
					loadChat(state.chats[0].id);
				} else {
					createNewChat();
				}

				renderHistory();
				setupEventListeners();
			}

			function setupEventListeners() {
				elements.newChatBtn.addEventListener('click', createNewChat);
				elements.sendButton.addEventListener('click', sendMessage);
				elements.clearAllBtn.addEventListener('click', () => {
					if(confirm('Delete all history?')) {
						state.chats = [];
						saveToLocal();
						createNewChat();
					}
				});

				elements.userInput.addEventListener('keydown', (e) => {
					if (e.key === 'Enter' && !e.shiftKey) {
						e.preventDefault();
						sendMessage();
					}
				});
				elements.userInput.addEventListener('input', function() {
					this.style.height = 'auto';
					this.style.height = (this.scrollHeight) + 'px';
				});
			}

			function createNewChat() {
				const newChat = {
					id: Date.now().toString(),
					title: 'New Chat',
					messages: [{
						role: 'assistant',
						content: "Hello! Messages are saved in your browser."
					}]
				};
				state.chats.unshift(newChat);
				loadChat(newChat.id);
				saveToLocal();
			}

			function loadChat(id) {
				state.currentChatId = id;
				const chat = state.chats.find(c => c.id === id);
				if (!chat) return;

				elements.chatMessages.innerHTML = '';
				chat.messages.forEach(msg => appendMessageUI(msg.role, msg.content));
				renderHistory();
			}

			function deleteChat(e, id) {
				e.stopPropagation();
				if(!confirm('Delete this chat?')) return;
				
				state.chats = state.chats.filter(c => c.id !== id);
				if (state.chats.length === 0) {
					createNewChat();
				} else if (state.currentChatId === id) {
					loadChat(state.chats[0].id);
				} else {
					renderHistory();
					saveToLocal();
				}
			}

			function renderHistory() {
				elements.historyList.innerHTML = '';
				state.chats.forEach(chat => {
					const div = document.createElement('div');
					div.className = `history-item ${chat.id === state.currentChatId ? 'active' : ''}`;
					div.textContent = chat.title || 'New Chat';
					div.onclick = () => loadChat(chat.id);

					const delBtn = document.createElement('button');
					delBtn.className = 'delete-chat';
					delBtn.innerHTML = '&times;';
					delBtn.onclick = (e) => deleteChat(e, chat.id);
					
					div.appendChild(delBtn);
					elements.historyList.appendChild(div);
				});
			}

			async function sendMessage() {
				const text = elements.userInput.value.trim();
				if (!text || state.isGenerating) return;

				const currentChat = state.chats.find(c => c.id === state.currentChatId);
				if (!currentChat) return;

				state.isGenerating = true;
				elements.userInput.value = '';
				elements.userInput.style.height = 'auto';
				elements.sendButton.disabled = true;

				currentChat.messages.push({ role: 'user', content: text });
				if (currentChat.messages.length === 2) { 
					currentChat.title = text.slice(0, 30);
				}
				appendMessageUI('user', text);
				saveToLocal();

				const assistantMsgDiv = appendMessageUI('assistant', '<span style="color:#888; font-style:italic;">Thinking...</span>');

				try {
					const response = await fetch('/api/chat', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ 
							messages: currentChat.messages.map(m => ({role: m.role, content: m.content}))
						})
					});

					if (!response.ok) throw new Error('Network response was not ok');

					const data = await response.json();
					const fullResponse = data.response;

					assistantMsgDiv.innerHTML = DOMPurify.sanitize(marked.parse(fullResponse));
					
					currentChat.messages.push({ role: 'assistant', content: fullResponse });
					saveToLocal();

				} catch (error) {
					assistantMsgDiv.textContent = "Error generating response.";
				} finally {
					state.isGenerating = false;
					elements.sendButton.disabled = false;
					elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
				}
			}

			function appendMessageUI(role, text) {
				const div = document.createElement('div');
				div.className = `message ${role === 'user' ? 'user-message' : 'assistant-message'} markdown-body`;
				if (role === 'assistant') {
					div.innerHTML = DOMPurify.sanitize(marked.parse(text));
				} else {
					div.textContent = text;
				}
				elements.chatMessages.appendChild(div);
				elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
				return div;
			}

			function saveToLocal() {
				localStorage.setItem('llm_chat_history', JSON.stringify(state.chats));
				renderHistory();
			}

			init();
		</script>
	</body>
</html>
